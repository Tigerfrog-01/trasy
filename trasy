using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using MailKit.Net.Smtp;
using System.Threading.Tasks;
using Filminurk.Core.Domain;
using Filminurk.Core.dto.AccountDTOs;
using Filminurk.Core.ServiceInterface;
using Microsoft.AspNetCore.Identity;
using Microsoft.Identity.Client;
using MimeKit;
using Org.BouncyCastle.Asn1.X509;
using Environment = Filminurk.Data.Enviroment;
using Microsoft.Extensions.Configuration;

namespace Filminurk.ApplicationServices.Services
{
    public class AccountsServices : IAccountsServices
    {
        private readonly UserManager<ApplicationUser> _userManager;
        private readonly SignInManager<ApplicationUser> _signInManager;
        private readonly IEmailsServices _emailsServices;
        private readonly IConfiguration _configuration;


        public AccountsServices(IConfiguration configuration)
        {
            _configuration = configuration;
        }


        public AccountsServices(UserManager<ApplicationUser> userManager, SignInManager<ApplicationUser> signInManager, IEmailsServices emailsServices)
        {
            _userManager = userManager;
            _signInManager = signInManager;
            _emailsServices = emailsServices;
        }

        public async Task<ApplicationUser> Register(ApplicationUserDTO userDTO)
        {
            var user = new ApplicationUser
            {
                UserName = userDTO.Email,
                Email = userDTO.Email,
                ProfileType = userDTO.ProfileType,
                DisplayName = userDTO.DisplayName,
            };
            var result = await _userManager.CreateAsync(user,userDTO.Password);
            if (result.Succeeded)
            {
                var token = await _userManager.GenerateEmailConfirmationTokenAsync(user);

                var email = new MimeMessage();
                _configuration.GetSection("EmailUserName").Value = Environment.gmailusername;
                _configuration.GetSection("EmailHost").Value = Environment.smtpaddress;
                _configuration.GetSection("EmailPassword").Value = Environment.gmailpassword;

                email.From.Add(MailboxAddress.Parse(_configuration.GetSection("EmailUserName").Value));
                email.To.Add(MailboxAddress.Parse(dto.SendToThisAddress));
                email.Subject = dto.EmailSubject;
                var builder = new BodyBuilder
                {
                    HtmlBody = dto.EmailContent,
                };
                email.Body = builder.ToMessageBody();
                using var smtp = new SmtpClient();

                smtp.Connect(_configuration.GetSection("EmailHost").Value, 587, MailKit.Security.SecureSocketOptions.StartTls);
                smtp.Authenticate(_configuration.GetSection("EmailUserName").Value, _configuration.GetSection("EmailPassword").Value);
                smtp.Send(email);
                smtp.Disconnect(true);

            }          
            return user;
        }
    

        
        public async Task<ApplicationUser> Login(LoginDTO userDTO)
        {
            var user = await _userManager.FindByEmailAsync(userDTO.Email);
            return user;
        }
    }

}
